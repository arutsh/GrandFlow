version: "3.9"

services:
  users-db:
    image: postgres:15
    container_name: users-db
    restart: always
    env_file:
      - ./services/users/.env.users.dev
    ports:
      - "5433:5432"   # host:container
    volumes:
      - users_data:/var/lib/postgresql/data

  budget-db:
    image: postgres:15
    container_name: budget-db
    restart: always
    env_file:
      - ./services/budget/.env.budget.dev
    ports:
      - "5434:5432"
    volumes:
      - budget_data:/var/lib/postgresql/data

  users:
    build:
      context: .
      dockerfile: services/users/Dockerfile
    container_name: users-service
    ports:
      - "8000:8000"   # FastAPI
      - "5678:5678"   # Debugpy
    volumes:
      - ./shared:/app/shared:ro
      - ./services/users:/app
    env_file:
      - ./services/users/.env.users.dev
    environment:
      - PYTHONPATH=/app
    depends_on:
      - users-db

  budget:
    build:
      context: .
      dockerfile: services/budget/Dockerfile
    container_name: budget-service
    ports:
      - "8001:8000"   # FastAPI
      - "5680:5680"   # Debugpy
    volumes:
      - ./shared:/app/shared:ro
      - ./services/budget:/app
      - ./uploads/budget:/app/uploads   # new volume for budget uploads
    env_file:
      - ./services/budget/.env.budget.dev
    environment:
      - PYTHONPATH=/app
    depends_on:
      - budget-db

  users-migrations:
    build:
      context: .
      dockerfile: services/users/Dockerfile
    container_name: users-migrations
    command: alembic upgrade head
    depends_on:
      - users-db
    volumes:
      - ./shared:/app/shared:ro
      - ./services/users:/app
    env_file:
      - ./services/users/.env.users.dev
    environment:
      - PYTHONPATH=/app
  budget-migrations:
    build:
      context: .
      dockerfile: services/budget/Dockerfile
    container_name: budget-migrations
    command: alembic upgrade head
    depends_on:
      - budget-db
    volumes:
      - ./shared:/app/shared:ro
      - ./services/budget:/app
    env_file:
      - ./services/budget/.env.budget.dev
    environment:
      - PYTHONPATH=/app
  
  gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    ports:
      - "8080:8080"   # Gateway listens on 8080
      - "5682:5682"   # Debugpy
    volumes:
      - ./shared:/app/shared:ro
      - ./api-gateway:/app
    env_file:
      - ./api-gateway/.env.gateway.dev
    depends_on:
      - users
      - budget
    environment:
      - PYTHONPATH=/app

  
  
  frontend:
      build:
        context: ./frontend-typescript
        dockerfile: Dockerfile
      container_name: frontend
      ports:
        - "3000:3000"
      environment:
        - VITE_API_BASE=http://localhost:8001/api
      volumes:
        - ./frontend-typescript:/app
        - /app/node_modules
      command: npm run dev
  
  nginx:
    image: nginx:latest
    container_name: api-proxy
    ports:
      - "8082:80"  # expose the unified entry point on localhost
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - gateway
      - users
      - budget
      - frontend

  redis:
    image: redis:7-alpine
    container_name: grandflow-redis
    ports:
      - "6379:6379"
volumes:
  users_data:
  budget_data:
